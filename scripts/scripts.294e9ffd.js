"use strict";var app=angular.module("smallBusinessApp",["ngSanitize","ngRoute","ngAutocomplete","firebase","ui.bootstrap"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/home.html",controller:"AuthCtrl"}).when("/register",{templateUrl:"views/register.html",controller:"AuthCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"AuthCtrl"}).when("/customers",{templateUrl:"views/customers.html",controller:"CustomersCtrl"}).when("/orders",{templateUrl:"views/orders.html",controller:"OrdersCtrl"}).when("/orders/:orderId",{templateUrl:"views/showorder.html",controller:"OrderViewCtrl"}).when("/servicereports",{templateUrl:"views/serviceReports.html"}).when("/contacts",{templateUrl:"views/contacts.html",controller:"ContactsCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/users/:username",{templateUrl:"views/profile.html",controller:"ProfileCtrl"}).otherwise({redirectTo:"/"})}]),app.config(["datepickerConfig","datepickerPopupConfig",function(a,b){b.showWeeks=!1,b.formatYear="yyyy",b.startingDay=1,b.showButtonBar=!1}]),app.constant("FIREBASE_URL","https://smallbusiness.firebaseio.com/"),app.run(function(){});var beforePrint=function(){console.log("Functionality to run before printing.")},afterPrint=function(){console.log("Functionality to run after printing")};if(window.matchMedia){var mediaQueryList=window.matchMedia("print");mediaQueryList.addListener(function(a){a.matches?beforePrint():afterPrint()})}window.onbeforeprint=beforePrint,window.onafterprint=afterPrint,app.controller("AuthCtrl",["$scope","$location","Auth","User",function(a,b,c,d){c.signedIn()&&(console.info("signedIn"),b.path("/")),a.$on("$firebaseSimpleLogin:login",function(){b.path("/")}),a.login=function(){a.user?c.login(a.user).then(function(){b.path("/")},function(b){a.error=b.toString()}):a.error="Please specify a user name and a password"},a.register=function(){c.register(a.user).then(function(c){d.create(c,a.user.username),b.path("/")},function(b){a.error=b.toString()})}}]),app.controller("NavCtrl",["$scope","$location","Auth",function(a,b,c){a.logout=function(){c.logout()}}]),app.controller("OrdersCtrl",["$scope","$location","Order",function(a,b,c){"/orders"===b.path()&&(a.orders=c.all);var d=new Date;a.orderPlaceholder={url:"http://",title:""},a.orderPlaceholder={customer:"",title:"",date:d,delivery:""},a.order=a.orderPlaceholder,a.submitOrder=function(){c.create(a.order).then(function(c){a.order=a.orderPlaceholder,b.path("/orders/"+c)})},a.deleteOrder=function(a){c.delete(a)}}]),app.controller("CustomersCtrl",["$scope","$location","Customer",function(a,b,c){console.info("customers controller..."),a.customers=c.all,console.log("$scope.customers:",a.customers),a.customerSelected="",console.log("$scope.typeof(customerSelected):",typeof a.customerSelected),a.customerIdCurrent=null,a.customerPlaceholder={name:"",piva:"",address:"",phone:"",email:"",dateCreation:""},a.customer=angular.copy(a.customerPlaceholder),a.customerAddMode=a.customerEditMode=!1,a.result1="",a.options1=null,a.details1="",a.submitCustomer=function(){var b=new Date;if(a.customer.dateCreation=b,a.customerEditMode){var d={};for(var e in a.customerPlaceholder)d[e]=a.customer[e];c.set(a.customerIdCurrent,d).then(function(){a.customer=angular.copy(a.customerPlaceholder)})}a.customerAddMode&&c.create(a.customer).then(function(b){a.customer=angular.copy(a.customerPlaceholder),console.log("customerId: ",b),console.log("$scope.customer: ",a.customer)}),a.customerAddMode=a.customerEditMode=!1},a.cancelCustomer=function(){a.customerAddMode=a.customerEditMode=!1,a.customer=angular.copy(a.customerPlaceholder)},a.deleteCustomer=function(a){c.delete(a)},a.editCustomer=function(b){console.log("customerId: ",b),a.customerEditMode?a.customerEditMode=!1:(a.customerIdCurrent=b,console.log("customerIdCurrent: ",a.customerIdCurrent),a.customer=c.find(b),a.customerEditMode=!0)},a.resetCustomerSelected=function(){a.customerSelected=""},a.typeof=function(a){return typeof a},a.match=function(a,b){var c=new RegExp(b,"g");return a.match(c)}}]),app.controller("ServicereportsCtrl",["$scope","$rootScope","$location","Servicereport","Customer","Auth","DateTime",function(a,b,c,d,e,f,g){a.servicereport={},a.servicereports=d.all,a.$watch(f.currentUser,function(b){b&&(a.servicereport.operator=a.currentUser.username)},!0),a.servicereports.$on("loaded",function(){a.servicereport.number=d.getNumberNext()}),a.initServicereport=function(){a.servicereport.operator=a.currentUser?a.currentUser.username:null,a.servicereport.dateIn=new Date,a.servicereport.dateOut=a.servicereport.dateIn,a.servicereport.duration=null,a.servicereport.customer=null,a.servicereport.location=null,a.servicereport.notes=null,a.servicereport.dateCreation=null,a.formAddEditSubmitted=!1,a.currentId=null,a.addMode=!1,a.editMode=!1,a.printMode=!1,a.orderby="-number",a.dateInit()},a.submitServicereport=function(b){a.formAddEditSubmitted=!0,b&&(a.servicereport.dateCreation=new Date,a.setDateOut(),a.editMode&&d.set(a.currentId,a.servicereport).then(function(){a.initServicereport()}),a.addMode&&d.create(a.servicereport).then(function(){a.servicereport.number=d.setNumberNext(a.servicereport.number),a.initServicereport()}),a.addMode=a.editMode=!1,a.formAddEditSubmitted=!1)},a.cancelServicereport=function(){a.addMode=a.editMode=a.printMode=!1,a.initServicereport()},a.deleteServicereport=function(a){var b=a.$id;d.delete(b)},a.editServicereport=function(b){var c=b.$id;a.editMode?a.editMode=!1:(a.currentId=c,a.servicereport=d.find(c),console.info("EDIT $scope.servicereport:",c,a.servicereport),a.editMode=!0)},a.preprintServicereport=function(b){var c=b.$id;a.printMode?a.printMode=!1:(a.currentId=c,a.servicereport=d.find(c),console.info("Preprint $scope.servicereport:",c,a.servicereport),a.printMode=!0)},a.printServicereport=function(){a.printMode&&(a.print(),window.onafterprint=function(){console.log("Printing dialog closed..."),a.printMode=!1,a.$apply()})},a.dateInit=function(){a.dateMin=null,a.dateMax=null,a.dateFormat="dd MMMM yyyy HH:mm",a.dateOptions={formatYear:"yyyy",startingDay:1,showWeeks:!1},a.dateDisabled=function(){return!1},a.dateOpen=function(b){b.preventDefault(),b.stopPropagation(),a.dateOpened=!0}},a.setDateOut=function(){var b=new g(a.servicereport.dateOut),c=a.servicereport.duration.split(":");b.addHours(c[0]||0),b.addMinutes(c[1]||0),a.servicereport.dateOut=b.get()},a.getCustomers=function(a){return console.info("getCustomers() - viewValue:",a),e.all},a.onCustomerSelect=function(b,c,d){console.info("onCustomerSelect() - item, model, label:",b,c,d),a.servicereport.customer=b,a.servicereport.location=b.address},a.typeof=function(a){return typeof a},a.match=function(a,b){var c=new RegExp(b,"g");return a.match(c)},a.print=function(){setTimeout(function(){window.print()},0)},a.initServicereport()}]),app.controller("ContactsCtrl",function(){}),app.controller("AboutCtrl",function(){}),app.controller("OrderViewCtrl",["$scope","$routeParams","Order",function(a,b,c){a.order=c.find(b.orderId),a.addItem=function(){c.addItem(b.orderId,a.item),a.item=""},a.deleteItem=function(b,d){c.deleteItem(a.order,b,d)}}]),app.controller("ProfileCtrl",["$scope","$routeParams","Order","User",function(a,b,c,d){function e(){a.orders={},angular.forEach(a.user.orders,function(b){a.orders[b]=c.find(b)})}function f(){a.items={},angular.forEach(a.user.items,function(b){var d=c.find(b.orderId);d.$on("loaded",function(){a.items[b.id]=d.$child("items").$child(b.id),a.ordersWithItems[b.orderId]=d})})}a.user=d.findByUsername(b.username),a.ordersWithItems={},a.user.$on("loaded",function(){e(),f()})}]),app.controller("ModalInstanceCtrl",["$scope","$modalInstance",function(a,b){a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}}]),app.factory("Auth",["$firebaseSimpleLogin","FIREBASE_URL","$rootScope",function(a,b,c){var d=new Firebase(b),e=a(d),f={register:function(a){return e.$createUser(a.email,a.password)},signedIn:function(){return null!==e.user?!0:!1},currentUser:function(){return null!==e.user?c.currentUser:null},login:function(a){return e.$login("password",{email:a.email,password:a.password,rememberMe:!0})},logout:function(){e.$logout()}};return c.signedIn=function(){return f.signedIn()},f}]),app.factory("Order",["$firebase","FIREBASE_URL","User",function(a,b,c){var d=new Firebase(b+"orders"),e=a(d),f={all:e,create:function(a){if(c.signedIn()){var b=c.getCurrent();return a.owner=b.username,e.$add(a).then(function(a){var c=a.name();return b.$child("orders").$child(c).$set(c),c})}},find:function(a){return e.$child(a)},"delete":function(a){if(c.signedIn()){var b=f.find(a);b.$on("loaded",function(){var d=c.findByUsername(b.owner);e.$remove(a).then(function(){d.$child("orders").$remove(a)})})}},addItem:function(a,b){if(c.signedIn()){var d=c.getCurrent();b.username=d.username,b.orderId=a,e.$child(a).$child("items").$add(b).then(function(b){d.$child("items").$child(b.name()).$set({id:b.name(),orderId:a})})}},deleteItem:function(a,b,d){if(c.signedIn()){var e=c.findByUsername(b.username);a.$child("items").$remove(d).then(function(){e.$child("items").$remove(d)})}}};return f}]),app.factory("Customer",["$firebase","FIREBASE_URL","User",function(a,b){var c=new Firebase(b+"customers"),d=a(c),e={all:d,create:function(a){return d.$add(a).then(function(a){var b=a.name();return b})},set:function(a,b){return d.$child(a).$set(b)},find:function(a){return d.$child(a)},findByCustomername:function(a){return a?d.$child(a):void 0},"delete":function(a){var b=e.find(a);b.$on("loaded",function(){d.$child(a).$set({deleted:!0})})}};return e}]),app.factory("Servicereport",["$firebase","FIREBASE_URL","User",function(a,b,c){var d=new Firebase(b+"servicereports"),e=a(d),f={all:e,create:function(a){if(c.signedIn()){var b=c.getCurrent();return a.owner=b.username,e.$add(a).then(function(a){var c=a.name();return b.$child("servicereports").$child(c).$set(c),c})}},set:function(a,b){return e.$child(a).$set(b)},find:function(a){return e.$child(a)},findByCustomername:function(a){return a?e.$child("customername").$child(a):void 0},getNumberNext:function(){var a=e.$child("stash").serviceReportNumber;return a=a?a:1,console.info("getNumberNext() - serviceReportNumber is now",a),a},setNumberNext:function(a){return a=a?a+1:1,console.info("setNumberNext() - serviceReportNumber will be",a),e.$child("stash").$set({serviceReportNumber:a}),a},"delete":function(a){if(c.signedIn()){console.info("DELETE SR SERVICE:",a);var b=f.find(a);b.$on("loaded",function(){var d=c.findByUsername(b.owner);console.info("delete SR service servicereportId"),e.$remove(a).then(function(){d&&d.$child("servicereports").$remove(a)})})}}};return f}]),app.factory("User",["$rootScope","$firebase","FIREBASE_URL",function(a,b,c){function d(b){a.currentUser=g.findByUsername(b)}var e=new Firebase(c+"users"),f=b(e),g={create:function(a,b){f[b]={md5_hash:a.md5_hash,username:b,$priority:a.uid},f.$save(b).then(function(){d(b)})},findByUsername:function(a){return a?f.$child(a):void 0},getCurrent:function(){return a.currentUser},signedIn:function(){return void 0!==a.currentUser}};return a.$on("$firebaseSimpleLogin:login",function(a,c){var f=b(e.startAt(c.uid).endAt(c.uid));f.$on("loaded",function(){d(f.$getIndex()[0])})}),a.$on("$firebaseSimpleLogin:logout",function(){delete a.currentUser}),g}]),app.factory("UserNotify",["$timeout",function(a){function b(a){d[a]=""}function c(){for(var a="",b=0;b<arguments.length;b++)a+=(b>0?" ":"")+JSON.stringify(arguments[b]);return a.replace(/^"/g,"").replace(/"$/g,"").replace(/\\/g,"")}toastr.options={closeButton:!1,debug:!1,positionClass:"toast-top-right",onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"3500",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"};var d=[];return{success:function(){var e=c.apply(this,arguments);d.success!==e&&(toastr.success(e),a(function(){b("success")},toastr.options.timeOut,!1),d.success=e)},info:function(){var e=c.apply(this,arguments);d.info!==e&&(toastr.info(e),a(function(){b("info")},toastr.options.timeOut,!1),d.info=e)},warning:function(){var e=c.apply(this,arguments);d.warning!==e&&(toastr.warning(e),a(function(){b("warning")},toastr.options.timeOut,!1),d.warning=e)},error:function(){var e=c.apply(this,arguments);d.error!==e&&(toastr.error(e),a(function(){b("error")},toastr.options.timeOut,!1),d.error=e)}}}]),app.factory("DateTime",function(){function a(a){void 0===a&&(this.date=new Date),this.date="[object Date]"===Object.prototype.toString.call(a)?a:new Date(a)}return a.prototype.get=function(){return this.date},a.prototype.addHours=function(a){this.date.setHours(this.date.getHours()+parseInt(a))},a.prototype.addMinutes=function(a){this.date.setMinutes(this.date.getMinutes()+parseInt(a))},a}),app.factory("Util",function(){var a={checkPhoneNumber:function(a){if(!a)return"Phone number is wrong: it can't be empty";var b=/^(?:(?:\+?1\s*(?:[.-]\s*)?)?(?:\(\s*([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9])\s*\)|([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]))\s*(?:[.-]\s*)?)?([2-9]1[02-9]|[2-9][02-9]1|[2-9][02-9]{2})\s*(?:[.-]\s*)?([0-9]{4})(?:\s*(?:#|x\.?|ext\.?|extension)\s*(\d+))?$/,c=new RegExp(b,"g");return null===a.match(c)?"Phone number doesn't apper to be valid":null},checkCodiceFiscale:function(a){if(!a)return"Codice fiscale is wrong: it can't be empty";if(a=a.toUpperCase(),16!==a.length)return"Codice fiscale is wrong: it's length should be exactly 16 characters";var b,c="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";for(b=0;16>b;b++)if(-1===c.indexOf(a.charAt(b)))return"Codice fiscale is wrong: it contains invalid character '"+a.charAt(b)+"'; valid characters are only letters and digits";var d="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",e="ABCDEFGHIJABCDEFGHIJKLMNOPQRSTUVWXYZ",f="ABCDEFGHIJKLMNOPQRSTUVWXYZ",g="BAKPLCQDREVOSFTGUHMINJWZYX",h=0;for(b=1;13>=b;b+=2)h+=f.indexOf(e.charAt(d.indexOf(a.charAt(b))));for(b=0;14>=b;b+=2)h+=g.indexOf(e.charAt(d.indexOf(a.charAt(b))));return h%26!==a.charCodeAt(15)-"A".charCodeAt(0)?"Codice fiscale is wrong: check code doesn't match":null},checkPartitaIVA:function(a){if(!a)return"Partita IVA is wrong: it can't be empty";if(11!==a.length)return"Partita IVA is wrong: it's length should be exactly 11 characters";var b,c="0123456789";for(b=0;11>b;b++)if(-1===c.indexOf(a.charAt(b)))return"Partita IVA is wrong: it contains invalid character '"+a.charAt(b)+"'; valid characters are only digits";var d=0;for(b=0;9>=b;b+=2)d+=a.charCodeAt(b)-"0".charCodeAt(0);for(b=1;9>=b;b+=2){var e=2*(a.charCodeAt(b)-"0".charCodeAt(0));e>9&&(e-=9),d+=e}return(10-d%10)%10!==a.charCodeAt(10)-"0".charCodeAt(0)?"Partita IVA is wrong: check code doesn't match":null}};return a}),app.directive("navCollapse",function(){return{restrict:"A",link:function(a,b){var c=!1;b.on("show.bs.collapse",function(){c=!0}),b.on("hide.bs.collapse",function(){c=!1}),b.on("click",function(){c&&"auto"===b.css("overflow-y")&&b.collapse("hide")})}}}),app.directive("autoFillSync",["$timeout",function(a){return{require:"ngModel",link:function(b,c,d,e){var f=c.val();a(function(){var a=c.val();e.$pristine&&f!==a&&e.$setViewValue(a)},500)}}}]),app.directive("autoFocus",["$timeout",function(a){return{scope:{trigger:"=autoFocus"},link:function(b,c){b.$watch("trigger",function(b){b&&a(function(){c[0].focus()})})}}}]),app.directive("checkUsername",["User",function(a){var b=/^[^.$\[\]#\/\s]+$/;return{require:"ngModel",link:function(c,d,e,f){f.$parsers.unshift(function(c){return b.test(c)?0===a.findByUsername(c).$getIndex().length?(f.$setValidity("taken",!0),f.$setValidity("invalid",!0),c):(f.$setValidity("taken",!1),void f.$setValidity("invalid",!0)):(f.$setValidity("taken",!0),void f.$setValidity("invalid",""===c))})}}}]),app.directive("equals",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){if(d){a.$watch(c.ngModel,function(){e()}),c.$observe("equals",function(){e()});var e=function(){var a=d.$viewValue,b=c.equals;d.$setValidity("equals",!(a&&b)||a===b)}}}}}),app.directive("reallyClick",["$modal",function(a){return{restrict:"A",scope:{reallyClick:"&",item:"="},link:function(b,c,d){c.bind("click",function(){var c=d.reallyMessage||"Are you sure?",e='<div class="modal-body">'+c+"</div>";e+='<div class="modal-footer"><button class="btn btn-primary" ng-click="ok()">OK</button><button class="btn btn-warning" ng-click="cancel()">Cancel</button></div>';var f=a.open({template:e,controller:"ModalInstanceCtrl"});f.result.then(function(){b.reallyClick({item:b.item})},function(){})})}}}]);var POSITIVE_INTEGER_REGEXP=/^\d+$/,DURATION_REGEXP=/^\d+[:.]\d+$/;app.directive("duration",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.unshift(function(a){var b=-1,c=-1;if(POSITIVE_INTEGER_REGEXP.test(a))b=parseInt(a),c=0;else if(DURATION_REGEXP.test(a)){var e=a.split(/\s*[:.]\s*/);b=parseInt(e[0]),c=parseInt(e[1]),c>=60&&(b=c=-1)}var f=60*b+c;return f>0?(d.$setValidity("duration",!0),a):void d.$setValidity("duration",!1)})}}}),app.filter("hostnameFromUrl",function(){return function(a){var b=document.createElement("a");return b.href=a,b.hostname}}),app.filter("onlySearched",function(){return function(a,b){var c=[];if(a&&b){for(var d in a)a[d].name===b&&c.push(a[d]);return c}return a}});