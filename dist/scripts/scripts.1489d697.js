"use strict";var app=angular.module("smallBusinessApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/orders.html",controller:"OrdersCtrl"}).when("/register",{templateUrl:"views/register.html",controller:"AuthCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"AuthCtrl"}).when("/orders/:orderId",{templateUrl:"views/showorder.html",controller:"OrderViewCtrl"}).when("/contacts",{templateUrl:"views/contacts.html",controller:"ContactsCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/users/:username",{templateUrl:"views/profile.html",controller:"ProfileCtrl"}).otherwise({redirectTo:"/"})}]),app.constant("FIREBASE_URL","https://smallbusiness.firebaseio.com/"),app.run(function(){}),app.controller("AuthCtrl",["$scope","$location","Auth","User",function(a,b,c,d){c.signedIn()?(console.info("signedIn"),b.path("/")):console.info("NOT signedIn"),a.$on("$firebaseSimpleLogin:login",function(){console.info("*************** $firebaseSimpleLogin:login did fire, redirecting to /"),b.path("/")}),a.login=function(){console.info("$scope.login() - $scope.user:",a.user),a.user?c.login(a.user).then(function(){console.info("Auth.login() returned - $scope.user:",a.user),b.path("/")},function(b){a.error=b.toString()}):a.error="Please specify a user name and a password"},a.register=function(){c.register(a.user).then(function(c){d.create(c,a.user.username),console.info("registered user:",c),b.path("/")},function(b){a.error=b.toString()})}}]),app.controller("NavCtrl",["$scope","$location","Auth",function(a,b,c){a.logout=function(){console.info("logout..."),c.logout()}}]),app.controller("OrdersCtrl",["$scope","$location","Order",function(a,b,c){"/"===b.path()&&(a.orders=c.all),a.orderPlaceholder={url:"http://",title:""},a.order=a.orderPlaceholder,a.submitOrder=function(){console.log("submitOrder in OrdersCtrl"),c.create(a.order).then(function(c){a.order=a.orderPlaceholder,b.path("/orders/"+c)})},a.deleteOrder=function(a){c.delete(a)}}]),app.controller("ContactsCtrl",function(){}),app.controller("AboutCtrl",function(){}),app.controller("OrderViewCtrl",["$scope","$routeParams","Order",function(a,b,c){a.order=c.find(b.orderId),a.addItem=function(){c.addItem(b.orderId,a.item),a.item=""},a.deleteItem=function(b,d){c.deleteItem(a.order,b,d)}}]),app.controller("ProfileCtrl",["$scope","$routeParams","Order","User",function(a,b,c,d){function e(){a.orders={},angular.forEach(a.user.orders,function(b){a.orders[b]=c.find(b)})}function f(){a.items={},angular.forEach(a.user.items,function(b){var d=c.find(b.orderId);d.$on("loaded",function(){a.items[b.id]=d.$child("items").$child(b.id),a.ordersWithItems[b.orderId]=d})})}a.user=d.findByUsername(b.username),a.ordersWithItems={},a.user.$on("loaded",function(){e(),f()})}]),app.factory("Auth",["$firebaseSimpleLogin","FIREBASE_URL","$rootScope",function(a,b,c){var d=new Firebase(b),e=a(d),f={register:function(a){return e.$createUser(a.email,a.password)},signedIn:function(){return null!==e.user?!0:!1},login:function(a){return e.$login("password",{email:a.email,password:a.password,rememberMe:!0})},logout:function(){e.$logout()}};return c.signedIn=function(){return f.signedIn()},f}]),app.factory("Order",["$firebase","FIREBASE_URL","User",function(a,b,c){var d=new Firebase(b+"orders"),e=a(d);console.info("ref:",d),console.info("orders:",e);var f={all:e,create:function(a){if(c.signedIn()){var b=c.getCurrent();return a.owner=b.username,e.$add(a).then(function(a){var c=a.name();return b.$child("orders").$child(c).$set(c),c})}},find:function(a){return e.$child(a)},"delete":function(a){if(c.signedIn()){var b=f.find(a);b.$on("loaded",function(){var d=c.findByUsername(b.owner);e.$remove(a).then(function(){d.$child("orders").$remove(a)})})}},addItem:function(a,b){if(c.signedIn()){var d=c.getCurrent();b.username=d.username,b.orderId=a,e.$child(a).$child("items").$add(b).then(function(b){d.$child("items").$child(b.name()).$set({id:b.name(),orderId:a})})}},deleteItem:function(a,b,d){if(c.signedIn()){var e=c.findByUsername(b.username);a.$child("items").$remove(d).then(function(){e.$child("items").$remove(d)})}}};return f}]),app.factory("User",["$rootScope","$firebase","FIREBASE_URL",function(a,b,c){function d(b){a.currentUser=g.findByUsername(b),console.log("setCurrentUser("+b+") - $rootScope.currentUser:",a.currentUser)}var e=new Firebase(c+"users"),f=b(e),g={create:function(a,b){f[b]={md5_hash:a.md5_hash,username:b,$priority:a.uid},f.$save(b).then(function(){d(b)})},findByUsername:function(a){return a?f.$child(a):void 0},getCurrent:function(){return a.currentUser},signedIn:function(){return console.info("$rootScope.currentUser:",a.currentUser),void 0!==a.currentUser}};return a.$on("$firebaseSimpleLogin:login",function(a,c){var f=b(e.startAt(c.uid).endAt(c.uid));f.$on("loaded",function(){console.info('query.$on("loaded" ...:',c.uid),d(f.$getIndex()[0])})}),a.$on("$firebaseSimpleLogin:logout",function(){console.info("Logout fired..."),delete a.currentUser}),g}]),app.directive("navCollapse",function(){return console.log("nav-collapse running..."),{restrict:"A",link:function(a,b){var c=!1;b.on("show.bs.collapse",function(){c=!0}),b.on("hide.bs.collapse",function(){c=!1}),b.on("click",function(){c&&"auto"===b.css("overflow-y")&&b.collapse("hide")})}}}),app.directive("autoFillSync",["$timeout",function(a){return{require:"ngModel",link:function(b,c,d,e){var f=c.val();a(function(){var a=c.val();e.$pristine&&f!==a&&e.$setViewValue(a)},500)}}}]),app.directive("autoFocus",["$timeout",function(a){return console.info("autoFocus is running..."),{scope:{trigger:"@autoFocus"},link:function(b,c){b.$watch("trigger",function(b){"true"===b&&a(function(){console.log("autoFocus:",c),c.focus()})})}}}]),app.directive("checkUsername",["User",function(a){var b=/^[^.$\[\]#\/\s]+$/;return{require:"ngModel",link:function(c,d,e,f){f.$parsers.unshift(function(c){return b.test(c)?0===a.findByUsername(c).$getIndex().length?(f.$setValidity("taken",!0),f.$setValidity("invalid",!0),c):(f.$setValidity("taken",!1),void f.$setValidity("invalid",!0)):(f.$setValidity("taken",!0),void f.$setValidity("invalid",""===c))})}}}]),app.directive("equals",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){if(d){a.$watch(c.ngModel,function(){e()}),c.$observe("equals",function(){e()});var e=function(){var a=d.$viewValue,b=c.equals;d.$setValidity("equals",!(a&&b)||a===b)}}}}}),app.filter("hostnameFromUrl",function(){return function(a){var b=document.createElement("a");return b.href=a,b.hostname}});